name: Benchmark + publish dataset

on:
  workflow_dispatch: {}
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  benchmark:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: site/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            **/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Generate dataset
        run: bun scripts/run-solutions.ts --timeoutMs 60000 --output site/public/data/latest.json

      - name: Commit dataset (main)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(dataset): update benchmark dataset [skip ci]"
          file_pattern: site/public/data/latest.json

